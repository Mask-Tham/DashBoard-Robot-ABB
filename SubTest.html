<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>

    <title>Hello, world!</title>
</head>
<script>
    function CreateSub() {
        xhr = new XMLHttpRequest;
        xhr.open("POST", "/subscription", true)
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.send("resources=1&1=/rw/system/energy&1-p=0")

        xhr.onreadystatechange = function () {
            // In local files, status is 0 upon success in Mozilla Firefox
            if (xhr.readyState === XMLHttpRequest.DONE) {
                var status = xhr.status;
                if (status === 0 || (status >= 200 && status < 400)) {
                    // The request has been completed successfully
                    var data = xhr.responseXML;
                    var location = data.childNodes[0].childNodes[3].childNodes[1].childNodes[1].href;   //Get location after create subscription
                    console.log('location',location);

                    websocket = new WebSocket(location, "robapi2_subscription");    //create websocket
                    websocket.onmessage = function (event) {    // listen Event
                        
                       
                        parser = new DOMParser();
                        xmlDoc = parser.parseFromString(event.data, "text/xml");
                        var RawValue = xmlDoc.getElementsByClassName("sys-energy-ev")[0].childNodes[1].innerHTML;
                        console.log('xmlDoc',xmlDoc);
                        var datafield = document.getElementById("Datafield");
                        var newdata = document.createElement('p');
                        newdata.innerHTML = RawValue;
                        datafield.appendChild(newdata);

                    }

                } else {
                    // Oh no! There has been an error with the request!
                }
            }
        };
    }


</script>

<body>
    <button onclick="CreateSub()">Create Subscription</button>
    <div id="Datafield">
        <p>start</p>
    </div>
</body>

</html>